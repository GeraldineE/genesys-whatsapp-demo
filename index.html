<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genesys WhatsApp Demo</title>
    <link
      rel="stylesheet"
      href="//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"
    />
  </head>
  <body>
    <script
      src="//sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"
      defer
    ></script>
    <script
      src="//cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"
      defer
    ></script>
    <script
      src="//cdn.jsdelivr.net/npm/alpinejs@3.13.6/dist/cdn.min.js"
      integrity="sha256-FTz1HAldsuHyr3y8w3VLPMUBshrpsxllBIGs9e+Wzzc="
      crossorigin="anonymous"
      defer
    ></script>

    <div x-data x-show="$store.auth.status === 'authenticating'">
      Authenticating...
    </div>
    <div x-data x-show="$store.auth.status === 'success'" style="display: none">
      <div
        x-data="tabs($store.app.selectedTabIndex)"
        x-modelable="selectedTabIndex"
        x-model="$store.app.selectedTabIndex"
        role="tablist"
      >
        <template x-data x-for="(tab, tabIndex) in $store.app.tabs">
          <button
            role="tab"
            type="button"
            @click="setSelectedTabIndex(tabIndex)"
            :style="{ backgroundColor: tabIndex === selectedTabIndex ? 'darkgrey' : 'none' }"
            x-text="tab.label"
          ></button>
        </template>
      </div>

      <div x-data x-show="$store.app.selectedTabIndex === 0">
        <select x-model.number="$store.app.selectedTemplateIndex">
          <template
            x-data
            x-for="(template, templateIndex) in $store.app.templates"
          >
            <option :value="templateIndex" x-text="template.label"></option>
          </template>
        </select>

        <textarea
          x-data
          x-text="$store.app.templates[$store.app.selectedTemplateIndex].value"
          rows="10"
          disabled
        >
        </textarea>
      </div>
      <div x-data x-show="$store.app.selectedTabIndex === 1">
        <template
          x-data
          x-for="(substitutionTag, substitutionTagIndex) in $store.app.substitutionTags"
          x-init="$store.app.substitutionTags = [{ key: 'agent_name', value: $store.auth.state?.user?.name, editable: false }]"
        >
          <div>
            <input type="text" name="key" x-model="substitutionTag.key" />
            <input type="text" name="value" x-model="substitutionTag.value" />
            <template x-data x-if="substitutionTag.editable">
              <button
                type="button"
                @click="deleteSubstituationTag(substitutionTagIndex)"
              >
                Delete
              </button>
            </template>
          </div>
        </template>
        <div
          x-data
          x-text="JSON.stringify($store.app.substitutionTags.reduce((output, current) => {
            if (!current.key) return output
            return { ...output, [current.key]: current.value }
          }, {}))"
        ></div>
        <button type="button" @click="$store.app.addEmptySubstitutionTag()">
          Set another key/value
        </button>
      </div>
      <div x-data x-show="$store.app.selectedTabIndex === 2">
        <textarea
          x-data
          x-text="Handlebars.compile($store.app.templates[$store.app.selectedTemplateIndex].value)($store.app.substitutionTags.reduce((output, current) => {
          if (!current.key) return output
          return { ...output, [current.key]: current.value }
        }, {}))"
          rows="10"
          disabled
        ></textarea>
      </div>
    </div>
    <div
      x-data
      x-show="$store.auth.status === 'error'"
      class="container"
      style="display: none"
    >
      <span x-data x-text="$store.auth.error"></span>
    </div>

    <script>
      window.__APP_NAME__ = "Genesys Whatsapp Demo";
      window.__APP_PLATFORM_ENV__ = "sae1.pure.cloud";
      window.__APP_PLATFORM_CLIENT_ID__ =
        "faacf95d-903f-4db1-b00a-ecd8697d57a0";
      window.__APP_PLATFORM_REDIRECT_URL__ = new URL(
        location.pathname,
        location
      ).href;
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        const platformClient = require("platformClient");
        const api = platformClient.ApiClient.instance;
        const usersApi = new platformClient.UsersApi();
        const searchParameters = new URLSearchParams(
          location.search.slice(1) || location.hash.slice(1)
        );

        api.setEnvironment(__APP_PLATFORM_ENV__);
        api.setAccessToken(
          "BlpZ9K9RROC6rqS1TltfvAdTBtTI15M1xANFHuzO3d1eWUc2Zhr6edpPRhvoHvN7zUpV_XEZy7k30wxpY0IBVg"
        );

        Alpine.store("auth", {
          async init() {
            const serverState = this.getServerState();
            const clientState = this.getClientState();

            try {
              if (serverState) {
                await api.loginImplicitGrant(
                  __APP_PLATFORM_CLIENT_ID__,
                  __APP_PLATFORM_REDIRECT_URL__
                );
                const user = await usersApi.getUsersMe();

                this.onAuthenticated({ ...serverState, user });
              } else {
                await api.loginImplicitGrant(
                  __APP_PLATFORM_CLIENT_ID__,
                  __APP_PLATFORM_REDIRECT_URL__,
                  { state: JSON.stringify(clientState) }
                );

                this.onAuthenticating();
              }
            } catch (error) {
              this.onError(error);
            }
          },
          state: undefined,
          error: null,
          status: "idle",
          getServerState() {
            return JSON.parse(
              decodeURIComponent(searchParameters.get("state"))
            );
          },
          getClientState() {
            return { appName: __APP_NAME__ };
          },
          onAuthenticated(state) {
            this.state = state;
            this.error = null;
            this.status = "success";
          },
          onAuthenticating() {
            this.state = undefined;
            this.error = null;
            this.status = "authenticating";
          },
          onError(error) {
            this.state = undefined;
            this.error = error.message;
            this.status = "error";
          },
        });
      });
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("tabs", (initSelectedTabIndex = 0) => ({
          selectedTabIndex: initSelectedTabIndex,
          setSelectedTabIndex(nextSelectedTabIndex) {
            this.selectedTabIndex = nextSelectedTabIndex;
          },
        }));
      });
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.store("app", {
          tabs: [
            { label: "Template selector", value: "TEMPLATE_SELECTOR" },
            { label: "Substitution tags", value: "SUBSTITUTION_TAGS" },
            { label: "Preview", value: "PREVIEW" },
          ],
          selectedTabIndex: 0,
          templates: [
            {
              label: "Plantilla - Iniciar Chat",
              value:
                "WhatsApp_Template_Header;iniciarchat;es_ES;3c47f583-41ca-4700-8362-ce9b2b9a3409;\n\nHola soy <<{{1}}>> de Monitoreo Inteligente\n\nTenemos información importante para darte.\n¿Cómo estás hoy?",
            },
            {
              label: "Plantilla - Saludo genérico Meta WhatsApp",
              value:
                "WhatsApp_Template;hello_world;en_US;3c47f583-41ca-4700-8362-ce9b2b9a3409;\n\nWelcome and congratulations!! This message demonstrates your ability to send a WhatsApp message notification from the Cloud API, hosted by Meta. Thank you for taking the time to test with us.\n\nWhatsApp Business Platform sample message\n",
            },
            {
              label: "Plantilla - Saludo genérico Monitoreo Inteligente",
              value:
                "WhatsApp_Template;saludo;es_ES;3c47f583-41ca-4700-8362-ce9b2b9a3409;\n\nSomos Monitoreo Inteligente\n\nTenemos una información importante que darte.",
            },
          ],
          selectedTemplateIndex: 0,
          substitutionTags: [],
          addEmptySubstitutionTag() {
            this.substitutionTags.push({
              key: "",
              value: "",
              editable: true,
            });
          },
          deleteSubstituationTag(substitutionTagIndex) {
            this.substitutionTags.splice(substitutionTagIndex, 1);
          },
        });
      });
    </script>
  </body>
</html>
