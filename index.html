<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genesys WhatsApp Demo</title>
  </head>
  <body>
    <script
      src="//sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"
      defer
    ></script>
    <script
      src="//cdn.jsdelivr.net/npm/alpinejs@3.13.6/dist/cdn.min.js"
      integrity="sha256-FTz1HAldsuHyr3y8w3VLPMUBshrpsxllBIGs9e+Wzzc="
      crossorigin="anonymous"
      defer
    ></script>

    <div
      x-data
      x-show="$store.auth.status === 'authenticating'"
      style="display: none"
    >
      Authenticating...
    </div>
    <div x-data x-show="$store.auth.status === 'success'" style="display: none">
      <span x-data x-text="$store.auth.state.user.name"></span>

      <div
        role="tablist"
        x-data="tabs($store.app.selectedTabIndex)"
        x-modelable="selectedTabIndex"
        x-model="$store.app.selectedTabIndex"
      >
        <button
          role="tab"
          type="button"
          @click="setSelectedTabIndex(0)"
          :style="{ backgroundColor: selectedTabIndex === 0 ? 'red' : '' }"
        >
          Template selector
        </button>
        <button
          role="tab"
          type="button"
          @click="setSelectedTabIndex(1)"
          :style="{ backgroundColor: selectedTabIndex === 1 ? 'red' : '' }"
        >
          Substitution tags
        </button>
        <button
          role="tab"
          type="button"
          @click="setSelectedTabIndex(2)"
          :style="{ backgroundColor: selectedTabIndex === 2 ? 'red' : '' }"
        >
          Preview
        </button>
      </div>

      <div x-data x-text="$store.app.selectedTabIndex"></div>
    </div>
    <div x-data x-show="$store.auth.status === 'error'" style="display: none">
      <span x-data x-text="$store.auth.error"></span>
    </div>

    <script>
      window.__APP_NAME__ = "Genesys Whatsapp Demo";
      window.__APP_PLATFORM_ENV__ = "sae1.pure.cloud";
      window.__APP_PLATFORM_CLIENT_ID__ =
        "faacf95d-903f-4db1-b00a-ecd8697d57a0";
      window.__APP_PLATFORM_REDIRECT_URL__ = new URL(
        location.pathname,
        location
      ).href;
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        const platformClient = require("platformClient");
        const api = platformClient.ApiClient.instance;
        const usersApi = new platformClient.UsersApi();
        const searchParameters = new URLSearchParams(
          location.search.slice(1) || location.hash.slice(1)
        );

        api.setEnvironment(__APP_PLATFORM_ENV__);
        api.setAccessToken(
          "BlpZ9K9RROC6rqS1TltfvAdTBtTI15M1xANFHuzO3d1eWUc2Zhr6edpPRhvoHvN7zUpV_XEZy7k30wxpY0IBVg"
        );

        Alpine.store("auth", {
          init() {
            const serverState = this.getServerState();
            const clientState = this.getClientState();

            if (serverState) {
              api
                .loginImplicitGrant(
                  __APP_PLATFORM_CLIENT_ID__,
                  __APP_PLATFORM_REDIRECT_URL__
                )
                .then(() => usersApi.getUsersMe())
                .then(
                  (user) => void this.onAuthenticated({ ...serverState, user })
                )
                .catch((e) => this.onError(e));
            } else {
              api
                .loginImplicitGrant(
                  __APP_PLATFORM_CLIENT_ID__,
                  __APP_PLATFORM_REDIRECT_URL__,
                  { state: JSON.stringify(clientState) }
                )
                .then(() => void this.onAuthenticating())
                .catch((e) => void this.onError(e));
            }
          },
          state: undefined,
          error: null,
          status: "idle",
          getServerState() {
            return JSON.parse(
              decodeURIComponent(searchParameters.get("state"))
            );
          },
          getClientState() {
            return { appName: __APP_NAME__ };
          },
          onAuthenticated(state) {
            this.state = state;
            this.error = null;
            this.status = "success";
          },
          onAuthenticating() {
            this.state = undefined;
            this.error = null;
            this.status = "authenticating";
          },
          onError(error) {
            this.state = undefined;
            this.error = error.message;
            this.status = "error";
          },
        });
      });
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("tabs", (initSelectedTabIndex = 0) => ({
          selectedTabIndex: initSelectedTabIndex,
          setSelectedTabIndex(nextSelectedTabIndex) {
            this.selectedTabIndex = nextSelectedTabIndex;
          },
        }));
      });
    </script>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.store("app", {
          selectedTabIndex: 0,
        });
      });
    </script>
  </body>
</html>
