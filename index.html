<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genesys WhatsApp Demo</title>
  </head>
  <body>
    <script
      src="//sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"
      defer
      async
    ></script>
    <script src="//unpkg.com/alpinejs" defer async></script>

    <div x-data="auth">
      <div x-show="!state">Authenticating...</div>
      <div x-show="state">Good</div>
    </div>

    <script>
      window.__APP_NAME__ = "Genesys Whatsapp Demo";
      window.__APP_PLATFORM_CLIENT_ID__ =
        "faacf95d-903f-4db1-b00a-ecd8697d57a0";
      window.__APP_PLATFORM_REDIRECT_URL__ =
        "https://dbritto-dev.github.io/genesys-whatsapp-demo/";
    </script>

    <script>
      const APP_NAME = window.__APP_NAME__;
      const APP_PLATFORM_CLIENT_ID = window.__APP_PLATFORM_CLIENT_ID__;
      const APP_PLATFORM_REDIRECT_URL = window.__APP_PLATFORM_REDIRECT_URL__;

      const platformClient = require("platformClient");
      const api = platformClient.ApiClient.instance;
      const usersApi = new platformClient.UsersApi();
      const searchParameters = new URLSearchParams(
        location.search.slice(1) || location.hash.slice(1)
      );

      document.addEventListener("alpine:init", () => {
        Alpine.data("auth", () => ({
          state: undefined,
          error: null,
          getServerState() {
            return JSON.parse(
              decodeURIComponent(searchParameters.get("state"))
            );
          },
          getClientState() {
            return { appName: APP_NAME };
          },
          onAuthenticated() {},
          onAuthenticating() {},
          onError() {},
          init() {
            console.log("init auth");

            const serverState = this.getServerState();
            const clientState = this.getClientState();

            if (serverState) {
              api
                .loginImplicitGrant(
                  APP_PLATFORM_CLIENT_ID,
                  APP_PLATFORM_REDIRECT_URL
                )
                .then(() => {
                  this.state = serverState;
                  this.onAuthenticated(this.state);
                })
                .catch((e) => {
                  this.state = undefined;
                  this.error = e.message;
                  this.onError(this.error);
                });
            } else {
              api
                .loginImplicitGrant(
                  APP_PLATFORM_CLIENT_ID,
                  APP_PLATFORM_REDIRECT_URL,
                  { state: JSON.stringify(clientState) }
                )
                .then(() => {
                  this.state = undefined;
                  this.error = null;
                  this.onAuthenticating(this.state);
                })
                .catch((e) => {
                  this.state = undefined;
                  this.error = e.message;
                  this.onError(this.error);
                });
            }
          },
          destroy() {},
        }));

        // Alpine.data("app", () => ({
        //   user: null,
        //   init() {
        //     consle.log("init app");

        //     usersApi
        //       .getUsersMe({ expand: ["presence"] })
        //       .then((r) => {
        //         console.log("[DATA:APP]", { r });
        //       })
        //       .catch((e) => {
        //         console.log("[DATA:APP]", e);
        //       });
        //   },
        //   destroy() {},
        // }));
      });
    </script>
  </body>
</html>
